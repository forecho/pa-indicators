//@version=6
indicator("PA Indicators", overlay=true, max_labels_count=500, max_boxes_count=500)

// ===== å‚æ•°è®¾ç½® =====
string grp_ema = "EMA è®¾ç½®"
ema20Length = input.int(20, "EMA20", minval=1, group=grp_ema)
ema240Length = input.int(240, "EMA240", minval=1, group=grp_ema)

string grp_kcounter = "Kçº¿è®¡æ•°å™¨è®¾ç½®"
showBarCount = input.bool(true, "Kçº¿è®¡æ•°", group=grp_kcounter)
// intervalCount = input.bool(true, "é—´éš”è®¡æ•°", group=grp_kcounter)
c_contador = input.int(title="é—´éš”è®¡æ•°", defval=2, group=grp_kcounter)
rthSession = input.session("0930-1615", "RTH(ç¾ä¸œæ—¶é—´)", group=grp_kcounter)
textSize = input.string("small", "æ–‡å­—å¤§å°", options=["tiny", "small", "normal", "large"], group=grp_kcounter)
textColor = input.color(color.new(color.purple, 5), "æ–‡å­—é¢œè‰²", group=grp_kcounter)

// IBS é¢œè‰²è®¾ç½®
string grp_ibs_color = "IBS é¢œè‰²è®¾ç½®"
baseBullColor = input.color(#26A69A, "é˜³çº¿åŸºç¡€é¢œè‰²", group=grp_ibs_color)
baseBearColor = input.color(#EF5350, "é˜´çº¿åŸºç¡€é¢œè‰²", group=grp_ibs_color)
rangeColor = input.color(color.new(#2196F3, 50), "åŒºé—´éœ‡è¡é¢œè‰²", group=grp_ibs_color)
enableRangeColor = input.bool(false, "å¯ç”¨åŒºé—´éœ‡è¡ç€è‰²", group=grp_ibs_color, tooltip="å¼€å¯åï¼Œå½±çº¿è¶…è¿‡é˜ˆå€¼çš„Kçº¿ä¼šæ˜¾ç¤ºä¸ºåŒºé—´éœ‡è¡é¢œè‰²")
wickThreshold = input.float(50, "å½±çº¿é˜ˆå€¼(%)", minval=0, maxval=100, step=5, group=grp_ibs_color, tooltip="å½±çº¿è¶…è¿‡æ­¤ç™¾åˆ†æ¯”æ—¶æ˜¾ç¤ºä¸ºåŒºé—´éœ‡è¡(è“è‰²)")

// IBS é€æ˜åº¦æ¸å˜ï¼šå¼ºåŠ¿(0%) â†’ æ™®é€š(30%) â†’ å¼±åŠ¿(85%)
color strongBullColor = color.new(baseBullColor, 0)    // å®è‰²
color strongBearColor = color.new(baseBearColor, 0)    // å®è‰²
color normalBullColor = color.new(baseBullColor, 30)   // ç¨é€æ˜
color normalBearColor = color.new(baseBearColor, 30)   // ç¨é€æ˜
color weakBullColor = color.new(baseBullColor, 85)     // å¾ˆæ·¡
color weakBearColor = color.new(baseBearColor, 85)     // å¾ˆæ·¡

// ç¼ºå£æ£€æµ‹è®¾ç½®
string grp_gap = "ç¼ºå£æ£€æµ‹è®¾ç½®"
enableGapDetection = input.bool(true, "å¯ç”¨ç¼ºå£æ£€æµ‹", group=grp_gap)
showOpenCloseGap = input.bool(false, "æ˜¾ç¤ºå¼€ç›˜å¯¹å‰æ”¶ Gap", group=grp_gap, tooltip="å½“å‰Kçº¿å¼€ç›˜ä»·ä¸ä¸Šä¸€æ ¹Kçº¿æ”¶ç›˜ä»·å­˜åœ¨ä»·å·®æ—¶ç«‹å³æ ‡è®°")
openCloseGapMinMove = input.float(0.0, "Gap æœ€å°ä»·å·®", minval=0, group=grp_gap, tooltip="ä»·å·®å°äºæ­¤æ•°å€¼æ—¶ä¸æ˜¾ç¤ºï¼Œ0 è¡¨ç¤ºè‡ªåŠ¨ä½¿ç”¨æœ€å°è·³åŠ¨")
openCloseGapTextSize = input.string("small", "Gap æ–‡å­—å¤§å°", options=["tiny", "small", "normal"], group=grp_gap)
openCloseGapUpColor = input.color(color.new(color.green, 70), "å‘ä¸Š Gap é¢œè‰²", group=grp_gap)
openCloseGapDownColor = input.color(color.new(color.red, 70), "å‘ä¸‹ Gap é¢œè‰²", group=grp_gap)

// L/H æ ‡è®°è®¾ç½®
string grp_lh = "L/H æ ‡è®°è®¾ç½®"
enableLH = input.bool(true, "å¯ç”¨ L/H æ ‡è®°", group=grp_lh)
lhTextSize = input.string("normal", "æ–‡å­—å¤§å°", options=["tiny", "small", "normal", "large"], group=grp_lh)
lColor = input.color(color.green, "L é¢œè‰²", group=grp_lh)
hColor = input.color(color.red, "H é¢œè‰²", group=grp_lh)
lLabelOffsetTicks = input.int(2, "L æ ‡ç­¾ä¸‹ç§»(è·³åŠ¨)", minval=0, group=grp_lh, tooltip="å‘ä¸‹ç§»åŠ¨ L æ ‡ç­¾ï¼Œå•ä½ä¸ºæœ€å°è·³åŠ¨(syminfo.mintick)")

// B1 æç¤ºè®¾ç½®
string grp_b1 = "B1 æç¤ºè®¾ç½®"
enableB1Hint = input.bool(true, "æ˜¾ç¤º B1 æç¤º", group=grp_b1)
gapThreshold = input.float(0.3, "è·³ç©ºé˜ˆå€¼(%)", minval=0.1, maxval=2, step=0.1, group=grp_b1, tooltip="é«˜å¼€/ä½å¼€çš„åˆ¤å®šé˜ˆå€¼")

// å…³é”®ä»·ä½è®¾ç½® (é¢œè‰²å‚è€ƒ bpa.pine)
string grp_prevday = "å…³é”®ä»·ä½è®¾ç½®"
showPrevDayLevels = input.bool(true, "æ˜¾ç¤ºå…³é”®ä»·ä½", group=grp_prevday)
showTodayOpenLevel = input.bool(true, "ä»Šæ—¥å¼€ç›˜", group=grp_prevday)
showPrevDayHighLevel = input.bool(true, "æ˜¨æ—¥é«˜ç‚¹", group=grp_prevday)
showPrevDayLowLevel = input.bool(true, "æ˜¨æ—¥ä½ç‚¹", group=grp_prevday)
showPrevDayCloseLevel = input.bool(true, "æ˜¨æ—¥æ”¶ç›˜", group=grp_prevday)
todayOpenColor = input.color(color.aqua, "ä»Šæ—¥å¼€ç›˜é¢œè‰²", group=grp_prevday)       // bpa: sOpenCol = color.aqua
prevDayHighColor = input.color(color.gray, "æ˜¨æ—¥é«˜ç‚¹é¢œè‰²", group=grp_prevday)     // bpa: pdsHiCol = color.gray
prevDayLowColor = input.color(color.gray, "æ˜¨æ—¥ä½ç‚¹é¢œè‰²", group=grp_prevday)      // bpa: pdsLoCol = color.gray
prevDayCloseColor = input.color(color.red, "æ˜¨æ—¥æ”¶ç›˜é¢œè‰²", group=grp_prevday)     // bpa: pdsCloseCol = color.red
prevDayLineStyle = input.string("è™šçº¿", "çº¿æ¡æ ·å¼", options=["å®çº¿", "è™šçº¿", "ç‚¹çº¿"], group=grp_prevday)  // bpa: line.style_solid
prevDayLineWidth = input.int(1, "çº¿æ¡å®½åº¦", minval=1, maxval=4, group=grp_prevday)

// æ—¥å†…æ³¢åŠ¨æ˜¾ç¤º
string grp_range = "æ—¥å†…æ³¢åŠ¨"
showSessionRangeInfo = input.bool(true, "æ˜¾ç¤ºæ—¥å†…æ³¢åŠ¨", group=grp_range)
avgSessionRangeLen = input.int(10, "å¹³å‡æ ·æœ¬æ•°", minval=1, maxval=100, group=grp_range)
// useTrueRangeForAsr = input.bool(true, "ä½¿ç”¨çœŸå®æ³¢åŠ¨(å«è·³ç©º)", group=grp_range)
rangeTextColor = input.color(color.white, "æ–‡å­—é¢œè‰²", group=grp_range)
rangeBgColor = input.color(color.new(color.black, 70), "èƒŒæ™¯é¢œè‰²", group=grp_range)

// ===== EMA =====
ema20 = ta.ema(close, ema20Length)
ema240 = ta.ema(close, ema240Length)
plot(ema20, "EMA20", color=color.green, linewidth=1)
plot(ema240, "EMA240", color=color.yellow, linewidth=1)

// ================================================================= //
// ===== IBS Kçº¿ç€è‰² + åŒºé—´éœ‡è¡æ£€æµ‹ =====
// ================================================================= //

// 1. è®¡ç®—IBSå€¼
float rangePrice = high - low
float ibs = rangePrice > 0 ? (close - low) / rangePrice * 100 : 50

// 2. è®¡ç®—å½±çº¿é•¿åº¦å æ¯”
float upperWick = high - math.max(open, close)  // ä¸Šå½±çº¿
float lowerWick = math.min(open, close) - low   // ä¸‹å½±çº¿
float upperWickPercent = rangePrice > 0 ? (upperWick / rangePrice * 100) : 0
float lowerWickPercent = rangePrice > 0 ? (lowerWick / rangePrice * 100) : 0

// 3. åˆ¤æ–­æ˜¯å¦ä¸ºåŒºé—´éœ‡è¡Kçº¿ï¼ˆä»»ä¸€å½±çº¿è¶…è¿‡é˜ˆå€¼ï¼‰
bool isRangeBar = upperWickPercent > wickThreshold or lowerWickPercent > wickThreshold
bool shouldColorRange = enableRangeColor and isRangeBar

// 4. æ ¸å¿ƒé€»è¾‘
isBullBar = close >= open

color bar_color = na

// ä¼˜å…ˆåˆ¤æ–­ï¼šå¦‚æœå¯ç”¨äº†åŒºé—´éœ‡è¡ç€è‰²ä¸”æ»¡è¶³æ¡ä»¶ï¼Œç›´æ¥ç”¨è“è‰²
if shouldColorRange
    bar_color := rangeColor
else
    // å¦åˆ™æŒ‰IBSé€»è¾‘ç€è‰²
    if isBullBar
        if ibs > 69
            bar_color := strongBullColor
        else if ibs < 31
            bar_color := weakBullColor
        else
            bar_color := normalBullColor
    else
        if ibs < 31
            bar_color := strongBearColor
        else if ibs > 69
            bar_color := weakBearColor
        else
            bar_color := normalBearColor

// 5. åº”ç”¨é¢œè‰²
barcolor(bar_color)

// ================================================================= //
// ===== L/H æ‘†åŠ¨é«˜ä½ç‚¹æ ‡è®°ï¼ˆå¸¦ç¼–å·ï¼Œåˆ›æ–°é«˜/ä½é‡ç½®ï¼‰=====
// ================================================================= //

// RTH å¼€ç›˜ï¼ˆB1ï¼‰ç”¨äºæ—¥å†…é‡ç½® L/H è®¡æ•°
bool isInRthSessionLH = not na(time(timeframe.period, rthSession, "America/New_York"))
bool isNewRthDayLH = ta.change(time("D", "America/New_York")) != 0
bool rthSessionStartLH = isInRthSessionLH and (isNewRthDayLH or not isInRthSessionLH[1])

// æ‘†åŠ¨è®¡æ•°åªç”¨å·¦ä¾§ç¡®è®¤ï¼Œä¸”åªæ ‡å…¥åœºKï¼ˆRTH å†…ï¼‰
int swingLen = 3
float lowestLeft = ta.lowest(low, swingLen + 1)[1]
float highestLeft = ta.highest(high, swingLen + 1)[1]
bool hasHistory = bar_index > swingLen

// è·å–æ–‡å­—å¤§å°
lhSize = lhTextSize == "tiny" ? size.tiny :
         lhTextSize == "small" ? size.small :
         lhTextSize == "normal" ? size.normal :
         size.large

// è¿½è¸ªè®¡æ•°ä¸å›è°ƒçŠ¶æ€
var int lCount = 0
var int hCount = 0
var float hLastLow = na
var float lLastHigh = na
var bool bullPB = false
var bool bearPB = false
var float bullPBL = na
var float bearPBH = na

if enableLH and isInRthSessionLH
    // RTH æ—¥å†…é‡ç½®
    if rthSessionStartLH
        lCount := 0
        hCount := 0
        hLastLow := na
        lLastHigh := na
        bullPB := false
        bearPB := false
        bullPBL := na
        bearPBH := na

    // åªåœ¨æœ‰è¶³å¤Ÿå†å²æ—¶åˆ¤æ–­
    if hasHistory
        // è®°å½•å¤šå¤´å›è°ƒ
        if low < low[1]
            bullPB := true
            bullPBL := na(bullPBL) ? low : math.min(bullPBL, low)

        // å¤šå¤´æ¢å¤ï¼šé«˜ç‚¹çªç ´å‰é«˜ï¼ˆä¸¥æ ¼ >ï¼‰ï¼Œæ ‡ H å…¥åœº
        if high > high[1] and bullPB
            hCount += 1
            if bullPBL > hLastLow or na(hLastLow)
                hCount := 1
            hLastLow := bullPBL
            bullPBL := na
            bullPB := false

            float hLabelOffset = lLabelOffsetTicks * syminfo.mintick * 5
            label.new(
                 x=bar_index,
                 y=high + hLabelOffset,
                 text="H" + str.tostring(hCount),
                 style=label.style_label_down,
                 color=color.new(hColor, 80),
                 textcolor=hColor,
                 size=lhSize
                 )

        // è®°å½•ç©ºå¤´åå¼¹
        if high > high[1]
            bearPB := true
            bearPBH := na(bearPBH) ? high : math.max(bearPBH, high)

        // ç©ºå¤´æ¢å¤ï¼šä½ç‚¹è·Œç ´å‰ä½ï¼ˆä¸¥æ ¼ <ï¼‰ï¼Œæ ‡ L å…¥åœº
        if low < low[1] and bearPB
            lCount += 1
            if bearPBH < lLastHigh or na(lLastHigh)
                lCount := 1
            lLastHigh := bearPBH
            bearPBH := na
            bearPB := false

            float lLabelOffset = lLabelOffsetTicks * syminfo.mintick * 4
            label.new(
                 x=bar_index,
                 y=low - lLabelOffset,
                 text="L" + str.tostring(lCount),
                 style=label.style_label_up,
                 color=color.new(lColor, 80),
                 textcolor=lColor,
                 size=lhSize
                 )

// ===== Kçº¿è®¡æ•° =====
currentTfMinutes = timeframe.in_seconds() / 60
inTimeRange = currentTfMinutes >= 5 and currentTfMinutes <= 60

var int barNumber = 0

if showBarCount and inTimeRange
    
    bool isInRth = not na(time(timeframe.period, rthSession, "America/New_York"))
    bool isNewDay = ta.change(time("D")) != 0
    bool isRthFirstBar = isNewDay and isInRth
    
    if isRthFirstBar
        barNumber := 1
    else if isInRth
        barNumber := barNumber + 1
    else
        barNumber := 0
    
    if barNumber > 0
        // é€»è¾‘å‚è€ƒ ex.pine: 
        // 1. ç¬¬ä¸€æ ¹Kçº¿(barNumber=1)æ€»æ˜¯æ˜¾ç¤º
        // 2. æ¯éš” c_contador (é»˜è®¤4) æ ¹æ˜¾ç¤ºä¸€æ¬¡
        // 3. ç¬¬ 12 æ ¹ (1å°æ—¶) æ˜¾ç¤ºçº¢è‰²
        
        bool shouldDisplay = barNumber == 1 or barNumber % c_contador == 0
        
        if shouldDisplay
            lblSize = textSize == "tiny" ? size.tiny :
              textSize == "small" ? size.small :
              textSize == "normal" ? size.normal :
              size.large

            // é¢œè‰²é€»è¾‘ï¼š12çš„å€æ•°(1å°æ—¶)æ˜¾ç¤ºçº¢è‰²ï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤é¢œè‰²
            color lblColor = barNumber % 12 == 0 ? color.red : textColor

            label.new(
                 x=bar_index, 
                 y=low - syminfo.mintick * 8, // ç¨å¾®ä¸Šç§»ä¸€ç‚¹ç‚¹ï¼Œé¿å…ä¸ä¸‹æ–¹Læ ‡ç­¾é‡å 
                 text=str.tostring(barNumber), 
                 style=label.style_none,
                 textcolor=lblColor,
                 size=lblSize,
                 yloc=yloc.price // æ”¹ç”¨ price å®šä½ä»¥ä¾¿å¾®è°ƒ
                 )

// ================================================================= //
// ===== å…³é”®ä»·ä½ï¼ˆåŸºäºRTHæ—¶æ®µï¼‰=====
// ================================================================= //

// ä½¿ç”¨ RTH session è®¡ç®—çœŸæ­£çš„å¼€ç›˜ä»·ã€æœ€é«˜ä»·ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·
bool isInRthSession = not na(time(timeframe.period, rthSession, "America/New_York"))
// æ—¥çº¿/é«˜å‘¨æœŸä¸‹ä¸Šä¸€æ ¹Kçº¿å¯èƒ½ä¹Ÿæ˜¯RTHå†…ï¼Œå› æ­¤ç”¨æ¢æ—¥ä¿¡å·è¾…åŠ©åˆ¤å®šå¼€ç›˜
bool isNewRthDay = ta.change(time("D", "America/New_York")) != 0
bool rthSessionStart = isInRthSession and (isNewRthDay or not isInRthSession[1])  // RTH ç¬¬ä¸€æ ¹Kçº¿

// è¿½è¸ªå½“æ—¥ RTH æ•°æ®
var float rthTodayOpen = na
var float rthTodayHigh = na
var float rthTodayLow = na
var float rthTodayClose = na
var int todaySessionStartIndex = na

// ä¿å­˜æ˜¨æ—¥ RTH æ•°æ®
var float rthYesterdayOpen = na
var float rthYesterdayHigh = na
var float rthYesterdayLow = na
var float rthYesterdayClose = na
var int yesterdaySessionStartIndex = na
var array<float> sessionRanges = array.new<float>()

// RTH å¼€å§‹æ—¶ï¼šä¿å­˜æ˜¨æ—¥æ•°æ®ï¼Œé‡ç½®ä»Šæ—¥æ•°æ®
if rthSessionStart
    // è®°å½•æ˜¨æ—¥å¼€ç›˜æ‰€åœ¨çš„ bar ç´¢å¼•ï¼Œç”¨äºçº¿æ¡å·¦ä¾§å®šä½åˆ°æ˜¨å¤© B1
    if not na(todaySessionStartIndex)
        yesterdaySessionStartIndex := todaySessionStartIndex
    todaySessionStartIndex := bar_index

    // å°†ä»Šæ—¥æ•°æ®ä¿å­˜ä¸ºæ˜¨æ—¥æ•°æ®
    if not na(rthTodayOpen)
        rthYesterdayOpen := rthTodayOpen
        rthYesterdayHigh := rthTodayHigh
        rthYesterdayLow := rthTodayLow
        rthYesterdayClose := rthTodayClose
        
        float _range = rthTodayHigh - rthTodayLow
        if not na(_range)
            array.push(sessionRanges, _range)
            if array.size(sessionRanges) > avgSessionRangeLen + 50
                array.shift(sessionRanges)

    // é‡ç½®ä»Šæ—¥æ•°æ®
    rthTodayOpen := open
    rthTodayHigh := high
    rthTodayLow := low
    rthTodayClose := close

// RTH æœŸé—´ï¼šæ›´æ–°æœ€é«˜ä»·ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·
if isInRthSession
    // å¦‚æœåœ¨ä¸­é€”åŠ è½½è„šæœ¬ï¼Œå°šæœªåˆå§‹åŒ–ï¼Œåˆ™ç”¨å½“å‰Kçº¿åˆå§‹åŒ–
    if na(rthTodayOpen)
        rthTodayOpen := open
        rthTodayHigh := high
        rthTodayLow := low
        rthTodayClose := close
    else
        rthTodayHigh := na(rthTodayHigh) ? high : math.max(rthTodayHigh, high)
        rthTodayLow := na(rthTodayLow) ? low : math.min(rthTodayLow, low)
        rthTodayClose := close

// ç”¨äº B1 æç¤ºçš„æ•°æ®ï¼ˆä½¿ç”¨ RTH æ•°æ®ï¼‰
todayOpen = rthTodayOpen
prevDayClose = rthYesterdayClose

// ç»˜åˆ¶å…³é”®ä»·ä½çº¿ï¼ˆä½¿ç”¨ line.new æ”¯æŒè™šçº¿æ ·å¼ï¼‰
keyLevelStyle = prevDayLineStyle == "å®çº¿" ? line.style_solid : prevDayLineStyle == "è™šçº¿" ? line.style_dashed : line.style_dotted
keyLevelExtend = extend.none  // ä½¿ç”¨è‡ªå®šä¹‰ x1/x2 æ§åˆ¶å»¶ä¼¸èŒƒå›´

var line todayOpenLine = na
var line prevDayHighLine = na
var line prevDayLowLine = na
var line prevDayCloseLine = na
var label todayOpenLabel = na
var label prevDayHighLabel = na
var label prevDayLowLabel = na
var label prevDayCloseLabel = na
var table sessionRangeTable = na

// å¦‚æœå…³é—­å…³é”®ä»·ä½æ˜¾ç¤ºï¼Œæ¸…é™¤å·²æœ‰çº¿æ¡å’Œæ ‡ç­¾
if not showPrevDayLevels
    line.delete(todayOpenLine)
    line.delete(prevDayHighLine)
    line.delete(prevDayLowLine)
    line.delete(prevDayCloseLine)
    label.delete(todayOpenLabel)
    label.delete(prevDayHighLabel)
    label.delete(prevDayLowLabel)
    label.delete(prevDayCloseLabel)
    todayOpenLine := na
    prevDayHighLine := na
    prevDayLowLine := na
    prevDayCloseLine := na
    todayOpenLabel := na
    prevDayHighLabel := na
    prevDayLowLabel := na
    prevDayCloseLabel := na

if showPrevDayLevels
    // å•ç‹¬å…³é—­æ—¶ä¹Ÿéœ€è¦ç§»é™¤å¯¹åº”çº¿æ¡/æ ‡ç­¾
    if not showTodayOpenLevel
        line.delete(todayOpenLine)
        label.delete(todayOpenLabel)
        todayOpenLine := na
        todayOpenLabel := na
    if not showPrevDayHighLevel
        line.delete(prevDayHighLine)
        label.delete(prevDayHighLabel)
        prevDayHighLine := na
        prevDayHighLabel := na
    if not showPrevDayLowLevel
        line.delete(prevDayLowLine)
        label.delete(prevDayLowLabel)
        prevDayLowLine := na
        prevDayLowLabel := na
    if not showPrevDayCloseLevel
        line.delete(prevDayCloseLine)
        label.delete(prevDayCloseLabel)
        prevDayCloseLine := na
        prevDayCloseLabel := na

    // RTH å¼€å§‹æ—¶ï¼šåˆ é™¤æ—§çº¿æ¡ï¼Œéšåæ ¹æ®å¯ç”¨æ•°æ®é‡æ–°åˆ›å»º
    if rthSessionStart
        line.delete(todayOpenLine)
        line.delete(prevDayHighLine)
        line.delete(prevDayLowLine)
        line.delete(prevDayCloseLine)
        label.delete(todayOpenLabel)
        label.delete(prevDayHighLabel)
        label.delete(prevDayLowLabel)
        label.delete(prevDayCloseLabel)
        todayOpenLine := na
        prevDayHighLine := na
        prevDayLowLine := na
        prevDayCloseLine := na
        todayOpenLabel := na
        prevDayHighLabel := na
        prevDayLowLabel := na
        prevDayCloseLabel := na
        
        // åˆ›å»ºä»Šæ—¥å¼€ç›˜çº¿ï¼ˆåªè¦æ‹¿åˆ° RTH å¼€ç›˜ä»·å°±ç»˜åˆ¶ï¼‰
        if showTodayOpenLevel and not na(rthTodayOpen)
            int leftIdxToday = nz(todaySessionStartIndex, bar_index)
            todayOpenLine := line.new(leftIdxToday, rthTodayOpen, bar_index + 1, rthTodayOpen, color=todayOpenColor, width=prevDayLineWidth, style=keyLevelStyle, extend=keyLevelExtend)
            todayOpenLabel := label.new(bar_index, rthTodayOpen, "å¼€ç›˜ " + str.tostring(rthTodayOpen, format.mintick), style=label.style_none, textcolor=todayOpenColor, size=size.normal, xloc=xloc.bar_index)
        
        // åˆ›å»ºæ˜¨æ—¥ä»·ä½çº¿ï¼ˆä»…å½“ä¸Šä¸€äº¤æ˜“æ—¥æ•°æ®å¯ç”¨æ—¶ç»˜åˆ¶ï¼‰
        int leftIdxPrev = nz(yesterdaySessionStartIndex, bar_index)
        if showPrevDayHighLevel and not na(rthYesterdayHigh)
            prevDayHighLine := line.new(leftIdxPrev, rthYesterdayHigh, bar_index + 1, rthYesterdayHigh, color=prevDayHighColor, width=prevDayLineWidth, style=keyLevelStyle, extend=keyLevelExtend)
            prevDayHighLabel := label.new(bar_index, rthYesterdayHigh, "æ˜¨é«˜ " + str.tostring(rthYesterdayHigh, format.mintick), style=label.style_none, textcolor=prevDayHighColor, size=size.normal, xloc=xloc.bar_index)
        if showPrevDayLowLevel and not na(rthYesterdayLow)
            prevDayLowLine := line.new(leftIdxPrev, rthYesterdayLow, bar_index + 1, rthYesterdayLow, color=prevDayLowColor, width=prevDayLineWidth, style=keyLevelStyle, extend=keyLevelExtend)
            prevDayLowLabel := label.new(bar_index, rthYesterdayLow, "æ˜¨ä½ " + str.tostring(rthYesterdayLow, format.mintick), style=label.style_none, textcolor=prevDayLowColor, size=size.normal, xloc=xloc.bar_index)
        if showPrevDayCloseLevel and not na(rthYesterdayClose)
            prevDayCloseLine := line.new(leftIdxPrev, rthYesterdayClose, bar_index + 1, rthYesterdayClose, color=prevDayCloseColor, width=prevDayLineWidth, style=keyLevelStyle, extend=keyLevelExtend)
            prevDayCloseLabel := label.new(bar_index, rthYesterdayClose, "æ˜¨æ”¶ " + str.tostring(rthYesterdayClose, format.mintick), style=label.style_none, textcolor=prevDayCloseColor, size=size.normal, xloc=xloc.bar_index)
    
    // æ›´æ–°æ ‡ç­¾ä½ç½®åˆ°æœ€å³è¾¹ï¼ˆæ¯æ ¹Kçº¿éƒ½æ›´æ–°ï¼‰
    int rightOffset = bar_index + 5
    if not na(todayOpenLine)
        line.set_x2(todayOpenLine, rightOffset)
    if not na(prevDayHighLine)
        line.set_x2(prevDayHighLine, rightOffset)
    if not na(prevDayLowLine)
        line.set_x2(prevDayLowLine, rightOffset)
    if not na(prevDayCloseLine)
        line.set_x2(prevDayCloseLine, rightOffset)
    
    if not na(todayOpenLabel)
        label.set_x(todayOpenLabel, rightOffset)
    if not na(prevDayHighLabel)
        label.set_x(prevDayHighLabel, rightOffset)
    if not na(prevDayLowLabel)
        label.set_x(prevDayLowLabel, rightOffset)
    if not na(prevDayCloseLabel)
        label.set_x(prevDayCloseLabel, rightOffset)

// ================================================================= //
// ===== æ—¥å†…æ³¢åŠ¨æ˜¾ç¤ºï¼ˆå½“å‰ & å¹³å‡ï¼‰===== //
// ================================================================= //

if not showSessionRangeInfo and not na(sessionRangeTable)
    table.delete(sessionRangeTable)
    sessionRangeTable := na

if showSessionRangeInfo
    if na(sessionRangeTable)
        sessionRangeTable := table.new(position.bottom_right, 2, 3, bgcolor=color.new(color.black, 50), frame_color=color.new(color.white, 90), border_width=1)
    
    // å½“å‰æ—¥å†…æ³¢åŠ¨/å¹³å‡æ—¥å†…æ³¢åŠ¨ï¼šä½¿ç”¨RTH Sessionæ•°æ®
    float currentRangeDisplay = na
    if isInRthSession or not na(rthTodayHigh)
        currentRangeDisplay := rthTodayHigh - rthTodayLow
    
    float avgSessionRange = na
    if array.size(sessionRanges) >= 1
        int len = math.min(avgSessionRangeLen, array.size(sessionRanges))
        array<float> slice = array.slice(sessionRanges, array.size(sessionRanges) - len)
        avgSessionRange := array.avg(slice)

    // è®¡ç®— Gapï¼šä»Šå¤©å¼€ç›˜ä»·ä¸æ˜¨å¤©æœ€é«˜/æœ€ä½çš„ gap
    float gapUp = 0.0
    float gapDown = 0.0
    if not na(rthTodayOpen) and not na(rthYesterdayHigh) and not na(rthYesterdayLow)
        // å‘ä¸Š gapï¼šä»Šå¤©å¼€ç›˜ > æ˜¨å¤©æœ€é«˜
        if rthTodayOpen > rthYesterdayHigh
            gapUp := rthTodayOpen - rthYesterdayHigh
        // å‘ä¸‹ gapï¼šä»Šå¤©å¼€ç›˜ < æ˜¨å¤©æœ€ä½
        else if rthTodayOpen < rthYesterdayLow
            gapDown := rthYesterdayLow - rthTodayOpen
    
    // æ ¼å¼åŒ–æ–‡æœ¬
    string strCurrentVal = na(currentRangeDisplay) ? "â€”" : str.tostring(currentRangeDisplay, format.mintick)
    string strAvgVal = na(avgSessionRange) ? "â€”" : str.tostring(avgSessionRange, format.mintick)
    string strGap = gapUp > 0 ? "+" + str.tostring(gapUp, format.mintick) : gapDown > 0 ? "-" + str.tostring(gapDown, format.mintick) : "0"
    
    // è¡¨æ ¼å†…å®¹å¡«å…… (Title, Value)
    table.cell(sessionRangeTable, 0, 0, "å½“å‰æ³¢åŠ¨", text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 60), text_halign=text.align_left)
    table.cell(sessionRangeTable, 1, 0, strCurrentVal, text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 50), text_halign=text.align_right)
    
    table.cell(sessionRangeTable, 0, 1, "å¹³å‡æ³¢åŠ¨ (" + str.tostring(avgSessionRangeLen) + ")", text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 60), text_halign=text.align_left)
    table.cell(sessionRangeTable, 1, 1, strAvgVal, text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 50), text_halign=text.align_right)
    
    table.cell(sessionRangeTable, 0, 2, "Gap", text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 60), text_halign=text.align_left)
    table.cell(sessionRangeTable, 1, 2, strGap, text_color=rangeTextColor, text_size=size.normal, bgcolor=color.new(color.black, 50), text_halign=text.align_right)

// è®¡ç®—ä»Šæ—¥è·³ç©ºç™¾åˆ†æ¯”
float todayGapPercent = not na(prevDayClose) and prevDayClose != 0 ? (todayOpen - prevDayClose) / prevDayClose * 100 : 0
bool isGapUp = todayGapPercent > gapThreshold
bool isGapDown = todayGapPercent < -gapThreshold

// åœ¨å³ä¸Šè§’æ˜¾ç¤ºæç¤º
// ä¼˜åŒ–æ ·å¼ï¼šèƒŒæ™¯ç¨å¾®è°ƒé«˜é€æ˜åº¦ï¼Œä½¿ç”¨é«˜äº®æ–‡å­—ä»¥é€‚åº”æ·±è‰²èƒŒæ™¯
var table hintTable = table.new(position.top_right, 1, 5, bgcolor=color.new(#131722, 30), frame_color=color.new(#2A2E39, 0), border_width=1)

// é…è‰²æ–¹æ¡ˆï¼šæ·±è‰²èƒŒæ™¯ä¸Šä½¿ç”¨é«˜äº®è‰² (Bright/Pastel Colors)
color colorUp = #4CAF50      // äº®ç»¿è‰²
color colorDown = #FF5252    // äº®çº¢è‰²
color colorText = #E0E0E0    // äº®ç°è‰²
color colorTextEmph = #FFFFFF // çº¯ç™½è‰²

if enableB1Hint and barstate.islast
    string gapPctText = str.tostring(math.abs(todayGapPercent), "#.##") + "%"
    
    if isGapUp
        // é«˜å¼€æ ‡é¢˜ï¼šä½¿ç”¨æ¶¨è‰²èƒŒæ™¯æ¡ï¼ˆåŠ æ·±ä¸é€æ˜åº¦ä»¥çªå‡ºæ ‡é¢˜ï¼‰
        table.cell(hintTable, 0, 0, "â–² é«˜å¼€ " + gapPctText, text_color=colorTextEmph, text_size=size.normal, bgcolor=color.new(colorUp, 20), text_halign=text.align_center)
        
        // ç­–ç•¥æç¤ºï¼šå¢å¤§å­—å·ï¼Œä½¿ç”¨é«˜äº®è‰²
        table.cell(hintTable, 0, 1, "ğŸ“ˆ åŒåº•/æ¥”å½¢åº• (EMAé™„è¿‘) â†’ åšå¤š", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 2, "ğŸ“ˆ çª„é€šé“ä¸Šå‡ â†’ é¡ºåŠ¿åšå¤š", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 3, "ğŸ“‰ åŒé¡¶/æ¥”å½¢é¡¶ â†’ åè½¬åšç©º", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 4, "ğŸ“‰ è·Œç ´EMAå›æŠ½ â†’ åšç©º", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)

    else if isGapDown
        // ä½å¼€æ ‡é¢˜ï¼šä½¿ç”¨è·Œè‰²èƒŒæ™¯æ¡
        table.cell(hintTable, 0, 0, "â–¼ ä½å¼€ " + gapPctText, text_color=colorTextEmph, text_size=size.normal, bgcolor=color.new(colorDown, 20), text_halign=text.align_center)
        
        // ç­–ç•¥æç¤º
        table.cell(hintTable, 0, 1, "ğŸ“‰ åŒé¡¶/æ¥”å½¢é¡¶ (EMAé™„è¿‘) â†’ åšç©º", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 2, "ğŸ“‰ çª„é€šé“ä¸‹è·Œ â†’ é¡ºåŠ¿åšç©º", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 3, "ğŸ“ˆ åŒåº•/æ¥”å½¢åº• â†’ åè½¬åšå¤š", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 4, "ğŸ“ˆ çªç ´EMAå›è¸© â†’ åšå¤š", text_color=colorTextEmph, text_size=size.normal, text_halign=text.align_left)

    else
        // å¹³å¼€
        table.cell(hintTable, 0, 0, "â–¶ å¹³å¼€ " + gapPctText, text_color=colorTextEmph, text_size=size.normal, bgcolor=color.new(color.gray, 50), text_halign=text.align_center)
        // å¹³å¼€æ—¶æ¸…ç©ºå…¶ä»–è¡Œï¼Œæˆ–æ˜¾ç¤ºé€šç”¨ç­–ç•¥
        table.cell(hintTable, 0, 1, "å…³æ³¨å¼€ç›˜åŒºé—´çªç ´", text_color=colorText, text_size=size.normal, text_halign=text.align_left)
        table.cell(hintTable, 0, 2, "", bgcolor=color.new(color.white, 100)) // æ¸…ç©º
        table.cell(hintTable, 0, 3, "", bgcolor=color.new(color.white, 100)) // æ¸…ç©º
        table.cell(hintTable, 0, 4, "", bgcolor=color.new(color.white, 100)) // æ¸…ç©º

// ================================================================= //
// ===== å¼€ç›˜ vs å‰æ”¶ Gap æ ‡è®°ï¼ˆå¼€ç›˜å³æ˜¾ç¤ºï¼‰===== //
// ================================================================= //

gapLabelSize = openCloseGapTextSize == "tiny" ? size.tiny :
         openCloseGapTextSize == "small" ? size.small :
         size.normal

float openCloseGapDiff = na
if bar_index > 0
    openCloseGapDiff := open - close[1]

float gapMinMove = openCloseGapMinMove > 0 ? openCloseGapMinMove : syminfo.mintick

bool hasOpenCloseGap = showOpenCloseGap and not na(openCloseGapDiff) and math.abs(openCloseGapDiff) >= gapMinMove
float openCloseGapMid = hasOpenCloseGap ? (open + close[1]) / 2 : na

if barstate.isnew and hasOpenCloseGap
    bool isOpenGapUp = openCloseGapDiff > 0
    string ocText = isOpenGapUp ? "Gapâ†‘ " + str.tostring(math.abs(openCloseGapDiff), format.mintick) : "Gapâ†“ " + str.tostring(math.abs(openCloseGapDiff), format.mintick)
    color gapBg = isOpenGapUp ? openCloseGapUpColor : openCloseGapDownColor
    label.new(bar_index, openCloseGapMid, ocText, style=isOpenGapUp ? label.style_label_up : label.style_label_down, color=gapBg, textcolor=color.white, size=gapLabelSize, yloc=yloc.price)

// ================================================================= //
// ===== ç¼ºå£æ£€æµ‹åŠŸèƒ½ =====
// ================================================================= //

// å›ºå®šé…ç½®
MAX_LOOKBACK = 2
GAP_UP_COLOR = color.new(color.green, 40)
GAP_DOWN_COLOR = color.new(color.red, 40)
MEASURING_UP_COLOR = color.new(color.green, 70)
MEASURING_DOWN_COLOR = color.new(color.red, 70)
DELETE_FILLED = true

// æ•°æ®ç»“æ„
type Gap
    box boxId
    float top
    float bottom
    bool isUp
    bool isMeasuring

var array<Gap> gaps = array.new<Gap>()

// æ—¶é—´å˜é‡ï¼ˆé¿å…é‡ç»˜è­¦å‘Šï¼‰
newDayET = ta.change(time("D", "America/New_York"))
isCurrentNewDay = newDayET != 0
isPrev1NewDay = ta.change(time("D", "America/New_York"))[1] != 0
isPrev2NewDay = ta.change(time("D", "America/New_York"))[2] != 0

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥ç¼ºå£æ˜¯å¦é‡å 
gapsOverlap(float top1, float bottom1, float top2, float bottom2) =>
    not (bottom1 >= top2 or bottom2 >= top1)

// ä¸»é€»è¾‘
if enableGapDetection and barstate.isconfirmed
    
    // --- 1. å…ˆæ£€æµ‹æµ‹é‡å‹ç¼ºå£ï¼ˆè·¨è¶Š2æ ¹Kçº¿çš„å¤§ç¼ºå£ï¼‰---
    if bar_index >= 2
        // åªæœ‰å½“è¿™3æ ¹Kçº¿éƒ½ä¸æ˜¯æ–°äº¤æ˜“æ—¥çš„ç¬¬ä¸€æ ¹æ—¶ï¼Œæ‰æ£€æµ‹æµ‹é‡å‹ç¼ºå£
        bool canDetectMeasuring = not isCurrentNewDay and not isPrev1NewDay and not isPrev2NewDay
        
        if canDetectMeasuring
            bool hasMeasuring = false
            float measuringTop = na
            float measuringBottom = na
            bool isUpMeasuring = false
            
            // å‘ä¸Šæµ‹é‡å‹ç¼ºå£ï¼šå½“å‰Kçº¿æœ€ä½ç‚¹ > å‰2æ ¹Kçº¿æœ€é«˜ç‚¹
            if low > high[2]
                hasMeasuring := true
                measuringTop := low
                measuringBottom := high[2]
                isUpMeasuring := true
            
            // å‘ä¸‹æµ‹é‡å‹ç¼ºå£ï¼šå½“å‰Kçº¿æœ€é«˜ç‚¹ < å‰2æ ¹Kçº¿æœ€ä½ç‚¹
            else if high < low[2]
                hasMeasuring := true
                measuringTop := low[2]
                measuringBottom := high
                isUpMeasuring := false
            
            if hasMeasuring
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç¼ºå£
                bool exists = false
                int size = array.size(gaps)
                if size > 0
                    for i = 0 to size - 1
                        g = array.get(gaps, i)
                        if math.abs(g.top - measuringTop) < 0.0001 and math.abs(g.bottom - measuringBottom) < 0.0001
                            exists := true
                            break
                
                if not exists
                    // æ ¹æ®æ–¹å‘é€‰æ‹©é¢œè‰²ï¼ˆæ— è¾¹æ¡†ï¼‰
                    color measuringColor = isUpMeasuring ? MEASURING_UP_COLOR : MEASURING_DOWN_COLOR
                    
                    newBox = box.new(bar_index - 2, measuringTop, bar_index, measuringBottom, 
                                   bgcolor=measuringColor, border_color=na)
                    array.push(gaps, Gap.new(newBox, measuringTop, measuringBottom, isUpMeasuring, true))
    
    // --- 2. æ£€æµ‹æ™®é€šè·³ç©ºç¼ºå£ï¼ˆç›¸é‚»2æ ¹Kçº¿ï¼‰---
    for offset = 1 to MAX_LOOKBACK
        if bar_index >= offset
            bool hasGap = false
            float gapTop = na
            float gapBottom = na
            bool isUpGap = false
            int startBar = bar_index - offset
            
            // å‘ä¸Šç¼ºå£ï¼šå½“å‰Kçº¿æœ€ä½ç‚¹ > å‰offsetæ ¹Kçº¿æœ€é«˜ç‚¹
            if low > high[offset]
                hasGap := true
                gapTop := low
                gapBottom := high[offset]
                isUpGap := true
            
            // å‘ä¸‹ç¼ºå£ï¼šå½“å‰Kçº¿æœ€é«˜ç‚¹ < å‰offsetæ ¹Kçº¿æœ€ä½ç‚¹
            else if high < low[offset]
                hasGap := true
                gapTop := low[offset]
                gapBottom := high
                isUpGap := false
            
            // ç»˜åˆ¶ç¼ºå£
            if hasGap
                // æ£€æŸ¥æ˜¯å¦ä¸æµ‹é‡å‹ç¼ºå£é‡å ï¼ˆæµ‹é‡å‹ç¼ºå£ä¼˜å…ˆï¼‰
                bool overlapsWithMeasuring = false
                int size = array.size(gaps)
                if size > 0
                    for i = 0 to size - 1
                        g = array.get(gaps, i)
                        if g.isMeasuring and gapsOverlap(gapTop, gapBottom, g.top, g.bottom)
                            overlapsWithMeasuring := true
                            break
                
                // å¦‚æœä¸ä¸æµ‹é‡å‹ç¼ºå£é‡å ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if not overlapsWithMeasuring
                    bool exists = false
                    if size > 0
                        for i = 0 to size - 1
                            g = array.get(gaps, i)
                            if math.abs(g.top - gapTop) < 0.0001 and math.abs(g.bottom - gapBottom) < 0.0001
                                exists := true
                                break
                    
                    if not exists
                        color gapColor = isUpGap ? GAP_UP_COLOR : GAP_DOWN_COLOR
                        newBox = box.new(startBar, gapTop, bar_index, gapBottom, bgcolor=gapColor, border_color=na)
                        array.push(gaps, Gap.new(newBox, gapTop, gapBottom, isUpGap, false))

// --- 3. æ£€æŸ¥ç¼ºå£å›è¡¥ ---
if enableGapDetection and DELETE_FILLED
    int size = array.size(gaps)
    if size > 0
        for i = size - 1 to 0
            g = array.get(gaps, i)
            bool isFilled = false
            
            if g.isUp
                // å‘ä¸Šç¼ºå£ï¼šä»·æ ¼å›è½åˆ°ä¸‹è¾¹ç•Œ
                if low <= g.bottom
                    isFilled := true
            else
                // å‘ä¸‹ç¼ºå£ï¼šä»·æ ¼å›å‡åˆ°ä¸Šè¾¹ç•Œ
                if high >= g.top
                    isFilled := true
            
            if isFilled
                box.delete(g.boxId)
                array.remove(gaps, i)
